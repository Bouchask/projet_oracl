<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Universit√©</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../static/style.css">
    <style>
        /* --- MODALE (POPUP) --- */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; top: 0; width: 100%; height: 100%; 
            background-color: rgba(0,0,0,0.5); 
            justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: white; 
            padding: 30px; 
            border-radius: 12px; 
            width: 400px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .close-btn {
            position: absolute; top: 10px; right: 15px; font-size: 20px; cursor: pointer; color: #aaa;
        }
        .close-btn:hover { color: #000; }
        .modal h3 { margin-top: 0; color: #2c3e50; }
        .modal label { font-weight: bold; display: block; margin-top: 10px; }
        .modal input, .modal select { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px; }

        /* --- ACTIONS BUTTONS --- */
        .btn-action { margin: 0 2px; padding: 6px 10px; border: none; border-radius: 4px; cursor: pointer; color: white; transition: 0.2s;}
        .btn-edit { background-color: #f39c12; } /* Orange pour Edit */
        .btn-edit:hover { background-color: #d35400; }
        .btn-lock { background-color: #34495e; } /* Gris fonc√© pour Bloquer */
        .btn-lock:hover { background-color: #2c3e50; }
        .btn-danger { background-color: #e74c3c; } /* Rouge pour Supprimer */
        .btn-danger:hover { background-color: #c0392b; }
        .btn-secondary { background-color: #3498db; } /* Bleu pour Voir */
        
        /* --- STATS CARDS --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; flex-direction: column; align-items: center; border-bottom: 4px solid #3498db; }
        .stat-number { font-size: 2.5em; font-weight: 700; color: #2c3e50; }
        .stat-label { color: #7f8c8d; font-weight: 600; text-transform: uppercase; font-size: 0.9em; letter-spacing: 1px; }
        
        /* --- SECTION INSCRIPTIONS --- */
        #registrationManager { background-color: #f8f9fa; border-left: 5px solid #3498db; padding: 20px; margin-top: 20px; border-radius: 8px; display: none; }
    </style>
</head>
<body>

    <div id="updateModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3 id="modalTitle">Modification</h3>
            <div id="modalBody">
                </div>
            <div style="margin-top: 20px; text-align: right;">
                <button class="btn-primary" onclick="submitUpdate()">Enregistrer</button>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <h2>üéì Admin Panel</h2>
        <button onclick="showSection('students')" class="active"><span>üë®‚Äçüéì</span> √âtudiants</button>
        <button onclick="showSection('teachers')"><span>üë®‚Äçüè´</span> Professeurs</button>
        <button onclick="showSection('courses')"><span>üìö</span> Cours</button>
        <button onclick="showSection('departments')"><span>üè¢</span> D√©partements</button>
        <button onclick="showSection('semesters')"><span>‚è≥</span> Semestres</button>
        <button onclick="showSection('salles')"><span>üö™</span> Salles</button>
        <button onclick="showSection('sections')"><span>üìÖ</span> Sections</button> 
        <button onclick="showSection('audit')"><span>üëÅÔ∏è</span> Audit Logs</button>
        <button onclick="logout()" class="logout-btn"><span>üö™</span> D√©connexion</button>
    </div>

    <div class="main-content">
        <div id="notification"></div>

        <div class="stats-grid">
            <div class="stat-card"><span class="stat-number" id="stat-students">0</span><span class="stat-label">√âtudiants</span></div>
            <div class="stat-card"><span class="stat-number" id="stat-teachers">0</span><span class="stat-label">Professeurs</span></div>
            <div class="stat-card"><span class="stat-number" id="stat-courses">0</span><span class="stat-label">Cours</span></div>
            <div class="stat-card"><span class="stat-number" id="stat-sections">0</span><span class="stat-label">Sections</span></div>
        </div>

        <div id="students" class="section-view active">
            <div class="header"><h1>Gestion des √âtudiants</h1></div>
            <div class="card">
                <h3>Ajouter un √âtudiant</h3>
                <div class="form-grid">
                    <div class="form-group"><label>Pr√©nom</label><input type="text" id="std_fname"></div>
                    <div class="form-group"><label>Nom</label><input type="text" id="std_lname"></div>
                    <div class="form-group"><label>Email</label><input type="email" id="std_email"></div>
                    <div class="form-group"><label>Niveau</label>
                        <select id="std_level"><option value="LICENCE">Licence</option><option value="MASTER">Master</option><option value="DEUG">DEUG</option></select>
                    </div>
                    <div class="form-group"><label>Mot de passe</label><input type="password" id="std_pass"></div>
                </div>
                <button class="btn-primary" onclick="addStudent()">Ajouter</button>
            </div>
            <div class="card">
                <h3>Liste des √âtudiants</h3>
                <button class="btn-secondary" onclick="loadStudents()">Actualiser</button>
                <div class="table-container">
                    <table id="studentsTable"><thead><tr><th>Code</th><th>Nom</th><th>Email</th><th>Niveau</th><th>Action</th></tr></thead><tbody></tbody></table>
                </div>
            </div>
        </div>

        <div id="teachers" class="section-view">
            <div class="header"><h1>Gestion des Professeurs</h1></div>
            <div class="card">
                <h3>Ajouter un Professeur</h3>
                <div class="form-grid">
                    <div class="form-group"><label>Nom Complet</label><input type="text" id="prof_name"></div>
                    <div class="form-group"><label>Email</label><input type="email" id="prof_email"></div>
                    <div class="form-group"><label>D√©partement</label><select id="prof_dept"><option value="">Chargement...</option></select></div>
                    <div class="form-group"><label>Mot de passe</label><input type="password" id="prof_pass"></div>
                </div>
                <button class="btn-primary" onclick="addTeacher()">Ajouter</button>
            </div>
            <div class="card">
                <h3>Liste des Professeurs</h3>
                <button class="btn-secondary" onclick="loadTeachers()">Actualiser</button>
                <div class="table-container">
                    <table id="teachersTable"><thead><tr><th>Code</th><th>Nom</th><th>Email</th><th>D√©pt</th><th>Action</th></tr></thead><tbody></tbody></table>
                </div>
            </div>
        </div>

        <div id="courses" class="section-view">
            <div class="header"><h1>Gestion des Cours</h1></div>
            <div class="card">
                <h3>Ajouter un Cours</h3>
                <div class="form-grid">
                    <div class="form-group"><label>Titre</label><input type="text" id="course_title"></div>
                    <div class="form-group"><label>Cr√©dits</label><input type="number" id="course_credits"></div>
                </div>
                <button class="btn-primary" onclick="addCourse()">Ajouter</button>
            </div>
            <div class="card">
                <h3>Liste des Cours</h3>
                <button class="btn-secondary" onclick="loadCourses()">Actualiser</button>
                <div class="table-container">
                    <table id="coursesTable"><thead><tr><th>Titre</th><th>Cr√©dits</th><th>Action</th></tr></thead><tbody></tbody></table>
                </div>
            </div>
        </div>

        <div id="departments" class="section-view">
            <div class="header"><h1>Gestion des D√©partements</h1></div>
            <div class="card">
                <h3>Ajouter un D√©partement</h3>
                <div class="form-group"><label>Nom</label><input type="text" id="dept_name"></div>
                <button class="btn-primary" onclick="addDepartment()">Ajouter</button>
            </div>
            <div class="card">
                <h3>Liste</h3>
                <button class="btn-secondary" onclick="loadDepartments()">Actualiser</button>
                <div class="table-container"><table id="departmentsTable"><thead><tr><th>ID</th><th>Nom</th><th>Action</th></tr></thead><tbody></tbody></table></div>
            </div>
        </div>

        <div id="semesters" class="section-view">
            <div class="header"><h1>Gestion des Semestres</h1></div>
            <div class="card">
                <h3>Ajouter Semestre</h3>
                <div class="form-grid">
                    <div class="form-group"><label>Nom</label><input type="text" id="sem_name"></div>
                    <div class="form-group"><label>D√©but</label><input type="date" id="sem_start"></div>
                    <div class="form-group"><label>Fin</label><input type="date" id="sem_end"></div>
                </div>
                <button class="btn-primary" onclick="addSemester()">Ajouter</button>
            </div>
            <div class="card">
                <h3>Liste</h3>
                <button class="btn-secondary" onclick="loadSemesters()">Actualiser</button>
                <div class="table-container"><table id="semestersTable"><thead><tr><th>Nom</th><th>Dates</th><th>Action</th></tr></thead><tbody></tbody></table></div>
            </div>
        </div>

        <div id="salles" class="section-view">
            <div class="header"><h1>Gestion des Salles</h1></div>
            <div class="card">
                <h3>Ajouter Salle</h3>
                <div class="form-grid">
                    <div class="form-group"><label>Code</label><input type="text" id="salle_code"></div>
                    <div class="form-group"><label>Capacit√©</label><input type="number" id="salle_cap"></div>
                    <div class="form-group"><label>B√¢timent</label><input type="text" id="salle_build"></div>
                </div>
                <button class="btn-primary" onclick="addSalle()">Ajouter</button>
            </div>
            <div class="card">
                <h3>Liste</h3>
                <button class="btn-secondary" onclick="loadSalles()">Actualiser</button>
                <div class="table-container"><table id="sallesTable"><thead><tr><th>Code</th><th>Cap.</th><th>B√¢t.</th><th>Action</th></tr></thead><tbody></tbody></table></div>
            </div>
        </div>

        <div id="sections" class="section-view">
            <div class="header"><h1>Gestion des Sections</h1></div>
            <div class="card">
                <h3>Cr√©er une Section</h3>
                <div class="form-grid">
                    <div class="form-group"><label>Cours</label><select id="sec_course"><option>Chargement...</option></select></div>
                    <div class="form-group"><label>Semestre</label><select id="sec_sem"><option>Chargement...</option></select></div>
                    <div class="form-group"><label>Professeur</label><select id="sec_prof"><option>Chargement...</option></select></div>
                    <div class="form-group"><label>Salle</label><select id="sec_salle"><option>Chargement...</option></select></div>
                    <div class="form-group"><label>Jour</label><select id="sec_day"><option>Lundi</option><option>Mardi</option><option>Mercredi</option><option>Jeudi</option><option>Vendredi</option><option>Samedi</option></select></div>
                    <div class="form-group"><label>D√©but (HH:MM)</label><input type="time" id="sec_start"></div>
                    <div class="form-group"><label>Fin (HH:MM)</label><input type="time" id="sec_end"></div>
                    <div class="form-group"><label>Capacit√©</label><input type="number" id="sec_cap" value="30"></div>
                </div>
                <button class="btn-primary" onclick="addSection()">Cr√©er Section</button>
            </div>
            
            <div class="card">
                <h3>Liste des Sections</h3>
                <button class="btn-secondary" onclick="loadSections()">Actualiser</button>
                <div class="table-container">
                    <table id="sectionsTable"><thead><tr><th>Cours</th><th>Semestre</th><th>Prof</th><th>Salle</th><th>Horaire</th><th>Inscrits</th><th>Action</th></tr></thead><tbody></tbody></table>
                </div>
            </div>

            <div id="registrationManager">
                <h3 id="regTitle" style="color: #2c3e50;">Inscriptions</h3>
                <div style="margin-bottom: 10px;"><button class="btn-danger" onclick="closeRegManager()">Fermer</button></div>
                <div class="table-container"><table id="regTable"><thead><tr><th>Etudiant</th><th>Code Apog√©e</th><th>Date</th><th>Statut</th><th>Action</th></tr></thead><tbody></tbody></table></div>
            </div>
        </div>

        <div id="audit" class="section-view">
            <div class="header"><h1>Audit Logs</h1></div>
            <div class="card"><button class="btn-primary" onclick="loadAudit()">Charger Logs</button><div class="table-container"><table id="auditTable"><thead><tr><th>ID</th><th>Etudiant</th><th>Cours</th><th>Avant</th><th>Apr√®s</th><th>Date</th></tr></thead><tbody></tbody></table></div></div>
        </div>
    </div>

    <script>
        const API_URL = "http://localhost:5000/api";
        let globalProfs = [], globalSalles = []; // Pour les formulaires d'√©dition

        window.onload = () => {
            loadStats();
            loadStudents();
            loadDeptDropdown();
            loadGlobalData(); // Pr√©charge profs et salles pour l'√©dition
        };

        function showSection(id) {
            document.querySelectorAll('.section-view').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.sidebar button').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            const buttons = document.querySelectorAll('.sidebar button');
            buttons.forEach(btn => { if(btn.getAttribute('onclick').includes(id)) btn.classList.add('active'); });

            // Chargement automatique selon la section
            if(id === 'students') loadStudents();
            if(id === 'teachers') { loadTeachers(); loadDeptDropdown(); }
            if(id === 'courses') loadCourses();
            if(id === 'departments') loadDepartments();
            if(id === 'semesters') loadSemesters();
            if(id === 'salles') loadSalles();
            if(id === 'sections') { loadSections(); loadSectionDropdowns(); loadGlobalData(); }
            if(id === 'audit') loadAudit();
            loadStats();
        }

        async function fetchAPI(endpoint, method="GET", body=null) {
            try {
                const options = { method: method, headers: {'Content-Type': 'application/json'} };
                if (body) options.body = JSON.stringify(body);
                const res = await fetch(`${API_URL}${endpoint}`, options);
                return await res.json();
            } catch (err) { console.error(err); return {error: "Erreur connexion"}; }
        }

        function showNotify(msg, isError = false) {
            const notif = document.getElementById('notification');
            notif.textContent = msg;
            notif.style.backgroundColor = isError ? '#e74c3c' : '#2ecc71';
            notif.style.display = 'block';
            setTimeout(() => notif.style.display = 'none', 3000);
        }

        // ==========================================
        // GESTION MODALE & MODIFICATIONS
        // ==========================================
        let currentUpdateType = "", currentUpdateId = "";

        function openModal(title, bodyHtml, updateType, id) {
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalBody').innerHTML = bodyHtml;
            currentUpdateType = updateType;
            currentUpdateId = id;
            document.getElementById('updateModal').style.display = 'flex';
        }
        function closeModal() { document.getElementById('updateModal').style.display = 'none'; }

        async function submitUpdate() {
            let body = {}; let url = "";
            const val = document.getElementById('new_val') ? document.getElementById('new_val').value : null;

            if (currentUpdateType === 'student_pass') { url = '/admin/student/password'; body = { code_apoge: currentUpdateId, new_password: val }; }
            else if (currentUpdateType === 'teacher_pass') { url = '/admin/teacher/password'; body = { code_apoge: currentUpdateId, new_password: val }; }
            else if (currentUpdateType === 'course_credits') { url = '/admin/course/credits'; body = { title: currentUpdateId, credits: val }; }
            else if (currentUpdateType === 'dept_name') { url = '/admin/departement/name'; body = { old_name: currentUpdateId, new_name: val }; }
            else if (currentUpdateType === 'sem_name') { url = '/admin/semester/name'; body = { old_name: currentUpdateId, new_name: val }; }
            else if (currentUpdateType === 'salle_cap') { url = '/admin/salle/capacity'; body = { code: currentUpdateId, capacity: val }; }
            else if (currentUpdateType === 'section_update') {
                url = '/admin/section/update';
                body = { section_id: currentUpdateId, instructor_id: document.getElementById('upd_prof').value, salle_id: document.getElementById('upd_salle').value };
            }

            const res = await fetchAPI(url, 'PUT', body);
            if(res && !res.error) { showNotify("Mise √† jour r√©ussie"); closeModal(); showSection(document.querySelector('.section-view.active').id); } 
            else showNotify("Erreur: " + (res.error || "Inconnue"), true);
        }

        // ==========================================
        // FONCTIONS LOADERS & CRUD
        // ==========================================

        // --- STATS ---
        async function loadStats() {
            const data = await fetchAPI('/admin/stats');
            if(data && !data.error) {
                document.getElementById('stat-students').innerText = data.students || 0;
                document.getElementById('stat-teachers').innerText = data.instructors || 0;
                document.getElementById('stat-courses').innerText = data.courses || 0;
                document.getElementById('stat-sections').innerText = data.sections || 0;
            }
        }

        // --- ETUDIANTS ---
        async function loadStudents() {
            const data = await fetchAPI('/admin/students');
            const tbody = document.querySelector("#studentsTable tbody"); tbody.innerHTML = "";
            if(data && !data.error) data.forEach(s => {
                tbody.innerHTML += `<tr><td>${s[1]}</td><td>${s[2]} ${s[3]}</td><td>${s[4]}</td><td>${s[5]}</td><td>
                    <button class="btn-action btn-edit" title="Changer MDP" onclick="openModal('Modifier Mot de passe', '<label>Nouveau mot de passe</label><input type=\\'password\\' id=\\'new_val\\' class=\\'form-control\\'>', 'student_pass', '${s[1]}')">‚úèÔ∏è</button>
                    <button class="btn-action btn-danger" onclick="deleteItem('/admin/student/${s[1]}')">üóëÔ∏è</button>
                </td></tr>`;
            });
        }
        async function addStudent() {
            const body = { first_name: document.getElementById('std_fname').value, last_name: document.getElementById('std_lname').value, email: document.getElementById('std_email').value, level: document.getElementById('std_level').value, password: document.getElementById('std_pass').value };
            const res = await fetchAPI('/admin/student', 'POST', body);
            if(res && !res.error) { showNotify("Etudiant ajout√©"); loadStudents(); } else showNotify("Erreur", true);
        }

        // --- PROFESSEURS ---
        async function loadTeachers() {
            const data = await fetchAPI('/admin/teachers');
            const tbody = document.querySelector("#teachersTable tbody"); tbody.innerHTML = "";
            if(data && !data.error) data.forEach(t => {
                tbody.innerHTML += `<tr><td>${t[1]}</td><td>${t[2]}</td><td>${t[3]}</td><td>${t[4]}</td><td>
                    <button class="btn-action btn-edit" title="Changer MDP" onclick="openModal('Modifier Mot de passe', '<label>Nouveau mot de passe</label><input type=\\'password\\' id=\\'new_val\\' class=\\'form-control\\'>', 'teacher_pass', '${t[1]}')">‚úèÔ∏è</button>
                    <button class="btn-action btn-danger" onclick="deleteItem('/admin/teacher/${t[1]}')">üóëÔ∏è</button>
                </td></tr>`;
            });
        }
        async function addTeacher() {
            const body = { name: document.getElementById('prof_name').value, email: document.getElementById('prof_email').value, dept_id: document.getElementById('prof_dept').value, password: document.getElementById('prof_pass').value };
            const res = await fetchAPI('/admin/teacher', 'POST', body);
            if(res && !res.error) { showNotify("Professeur ajout√©"); loadTeachers(); } else showNotify("Erreur", true);
        }

        // --- COURS ---
        async function loadCourses() {
            const data = await fetchAPI('/admin/courses');
            const tbody = document.querySelector("#coursesTable tbody"); tbody.innerHTML = "";
            if(data && !data.error) data.forEach(c => {
                tbody.innerHTML += `<tr><td>${c[1]}</td><td>${c[2]}</td><td>
                    <button class="btn-action btn-edit" title="Modifier cr√©dits" onclick="openModal('Modifier Cr√©dits', '<label>Nouveaux cr√©dits</label><input type=\\'number\\' id=\\'new_val\\' value=\\'${c[2]}\\'>', 'course_credits', '${c[1]}')">‚úèÔ∏è</button>
                    <button class="btn-action btn-danger" onclick="deleteItem('/admin/course/${c[1]}')">üóëÔ∏è</button>
                </td></tr>`;
            });
        }
        async function addCourse() {
            const body = { title: document.getElementById('course_title').value, credits: document.getElementById('course_credits').value };
            const res = await fetchAPI('/admin/course', 'POST', body);
            if(res && !res.error) { showNotify("Cours ajout√©"); loadCourses(); } else showNotify("Erreur", true);
        }

        // --- AUTRES (Depart, Semestre, Salle) ---
        async function loadDepartments() {
            const data = await fetchAPI('/admin/departments');
            const tbody = document.querySelector("#departmentsTable tbody"); tbody.innerHTML = "";
            if(data && !data.error) data.forEach(d => {
                tbody.innerHTML += `<tr><td>${d[0]}</td><td>${d[1]}</td><td>
                    <button class="btn-action btn-edit" onclick="openModal('Renommer', '<label>Nouveau nom</label><input type=\\'text\\' id=\\'new_val\\' value=\\'${d[1]}\\'>', 'dept_name', '${d[1]}')">‚úèÔ∏è</button>
                    <button class="btn-action btn-danger" onclick="deleteItem('/admin/departement/${d[1]}')">üóëÔ∏è</button>
                </td></tr>`;
            });
        }
        async function addDepartment() { const res = await fetchAPI('/admin/departement', 'POST', { name: document.getElementById('dept_name').value }); if(res && !res.error) { showNotify("Ajout√©"); loadDepartments(); } }

        async function loadSemesters() {
            const data = await fetchAPI('/admin/semesters');
            const tbody = document.querySelector("#semestersTable tbody"); tbody.innerHTML = "";
            if(data && !data.error) data.forEach(s => {
                tbody.innerHTML += `<tr><td>${s[1]}</td><td>${s[2]} - ${s[3]}</td><td>
                    <button class="btn-action btn-edit" onclick="openModal('Renommer', '<label>Nouveau nom</label><input type=\\'text\\' id=\\'new_val\\' value=\\'${s[1]}\\'>', 'sem_name', '${s[1]}')">‚úèÔ∏è</button>
                    <button class="btn-action btn-danger" onclick="deleteItem('/admin/semester/${s[1]}')">üóëÔ∏è</button>
                </td></tr>`;
            });
        }
        async function addSemester() { const body = { name: document.getElementById('sem_name').value, start_date: document.getElementById('sem_start').value, end_date: document.getElementById('sem_end').value }; const res = await fetchAPI('/admin/semester', 'POST', body); if(res && !res.error) { showNotify("Ajout√©"); loadSemesters(); } }

        async function loadSalles() {
            const data = await fetchAPI('/admin/salles');
            const tbody = document.querySelector("#sallesTable tbody"); tbody.innerHTML = "";
            if(data && !data.error) data.forEach(s => {
                tbody.innerHTML += `<tr><td>${s[1]}</td><td>${s[2]}</td><td>${s[3]}</td><td>
                    <button class="btn-action btn-edit" onclick="openModal('Capacit√©', '<label>Nouvelle capacit√©</label><input type=\\'number\\' id=\\'new_val\\' value=\\'${s[2]}\\'>', 'salle_cap', '${s[1]}')">‚úèÔ∏è</button>
                    <button class="btn-action btn-danger" onclick="deleteItem('/admin/salle/${s[1]}')">üóëÔ∏è</button>
                </td></tr>`;
            });
        }
        async function addSalle() { const body = { code: document.getElementById('salle_code').value, capacity: document.getElementById('salle_cap').value, building: document.getElementById('salle_build').value }; const res = await fetchAPI('/admin/salle', 'POST', body); if(res && !res.error) { showNotify("Ajout√©"); loadSalles(); } }

        // --- SECTIONS ---
        async function loadGlobalData() {
            const p = await fetchAPI('/admin/teachers');
            const s = await fetchAPI('/admin/salles');
            if(p && !p.error) globalProfs = p;
            if(s && !s.error) globalSalles = s;
        }
        
        async function loadSections() {
            const data = await fetchAPI('/admin/sections');
            const tbody = document.querySelector("#sectionsTable tbody"); tbody.innerHTML = "";
            if(data && !data.error) data.forEach(s => {
                const timeStr = `${s[5]} ${new Date(s[6]).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} - ${new Date(s[7]).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;
                // Formulaire pour modifier prof et salle
                const formHtml = `<label>Professeur</label><select id="upd_prof">${globalProfs.map(p => `<option value="${p[0]}">${p[2]}</option>`).join('')}</select><br><br><label>Salle</label><select id="upd_salle">${globalSalles.map(sl => `<option value="${sl[0]}">${sl[1]}</option>`).join('')}</select>`;
                
                tbody.innerHTML += `<tr><td>${s[1]}</td><td>${s[2]}</td><td>${s[3]}</td><td>${s[4]}</td><td>${timeStr}</td><td>${s[8]} / ${s[9]}</td><td>
                    <button class="btn-action btn-secondary" onclick="manageRegistrations(${s[0]}, '${s[1]}')">üë•</button>
                    <button class="btn-action btn-edit" onclick="openModal('Modifier Section', \`${formHtml}\`, 'section_update', ${s[0]})">‚úèÔ∏è</button>
                    <button class="btn-action btn-lock" title="Bloquer inscriptions" onclick="blockSection(${s[0]})">üîí</button>
                    <button class="btn-action btn-danger" onclick="deleteItem('/admin/section/${s[0]}')">üóëÔ∏è</button>
                </td></tr>`;
            });
        }
        async function addSection() { /* (Garder la logique existante) */ 
            const day = "2026-01-01"; const start = `${day} ${document.getElementById('sec_start').value}:00`; const end = `${day} ${document.getElementById('sec_end').value}:00`;
            const body = { course_code: document.getElementById('sec_course').value, semester_id: document.getElementById('sec_sem').value, instructor_id: document.getElementById('sec_prof').value, salle_id: document.getElementById('sec_salle').value, capacity: document.getElementById('sec_cap').value, day: document.getElementById('sec_day').value, start: start, end: end };
            const res = await fetchAPI('/admin/section', 'POST', body);
            if(res && !res.error) { showNotify("Cr√©√©e"); loadSections(); } else showNotify("Erreur", true);
        }
        async function blockSection(id) {
            if(!confirm("Bloquer les inscriptions (Capacit√© = Inscrits) ?")) return;
            const res = await fetchAPI('/admin/section/block', 'PUT', { section_id: id });
            if(res && !res.error) { showNotify("Section bloqu√©e"); loadSections(); } else showNotify("Erreur", true);
        }

        async function manageRegistrations(secId, title) {
            document.getElementById('registrationManager').style.display = 'block';
            document.getElementById('regTitle').innerText = `Inscriptions : ${title}`;
            const data = await fetchAPI(`/admin/section/${secId}/registrations`);
            const tbody = document.querySelector("#regTable tbody"); tbody.innerHTML = "";
            if(data && !data.error) data.forEach(r => {
                let actions = r[4] === 'ACTIVE' ? `<button class="btn-danger" onclick="updateStatus(${r[0]}, 'CANCELLED', ${secId}, '${title}')">Annuler</button>` : `<button class="btn-primary" onclick="updateStatus(${r[0]}, 'ACTIVE', ${secId}, '${title}')">Accepter</button>`;
                tbody.innerHTML += `<tr><td>${r[1]} ${r[2]}</td><td>${r[3]}</td><td>${new Date(r[5]).toLocaleDateString()}</td><td><strong>${r[4]}</strong></td><td>${actions}</td></tr>`;
            });
            document.getElementById('registrationManager').scrollIntoView({behavior: 'smooth'});
        }
        async function updateStatus(regId, status, secId, title) { const res = await fetchAPI('/admin/registration/status', 'PUT', { registration_id: regId, status: status }); if(res && !res.error) manageRegistrations(secId, title); }
        function closeRegManager() { document.getElementById('registrationManager').style.display = 'none'; }

        // --- UTILS ---
        async function deleteItem(endpoint) { if(!confirm("Confirmer la suppression ?")) return; const res = await fetchAPI(endpoint, 'DELETE'); if(res && !res.error) { showNotify("Supprim√©"); showSection(document.querySelector('.section-view.active').id); } else showNotify("Erreur", true); }
        async function loadSectionDropdowns() { /* ... Code standard de remplissage des selects ... */ 
            const courses = await fetchAPI('/admin/courses'); const sems = await fetchAPI('/admin/semesters'); const profs = await fetchAPI('/admin/teachers'); const salles = await fetchAPI('/admin/salles');
            populateSelect('sec_course', courses, 0, 1); populateSelect('sec_sem', sems, 0, 1); populateSelect('sec_prof', profs, 0, 2); populateSelect('sec_salle', salles, 0, 1);
        }
        async function loadDeptDropdown() { const data = await fetchAPI('/admin/departments'); const select = document.getElementById('prof_dept'); select.innerHTML = '<option value="" disabled selected>Choisir...</option>'; if(data && !data.error) data.forEach(d => select.innerHTML += `<option value="${d[0]}">${d[1]}</option>`); }
        function populateSelect(id, data, valIdx, textIdx) { const el = document.getElementById(id); el.innerHTML = ""; if(data && !data.error) data.forEach(item => el.innerHTML += `<option value="${item[valIdx]}">${item[textIdx]}</option>`); }
        async function loadAudit() { const data = await fetchAPI('/admin/audit'); const tbody = document.querySelector("#auditTable tbody"); tbody.innerHTML = ""; if(data && !data.error) data.forEach(log => tbody.innerHTML += `<tr><td>${log[0]}</td><td>${log[1]}</td><td>${log[2]}</td><td>${log[3]}</td><td>${log[4]}</td><td>${log[5]}</td></tr>`); }
        function logout() { window.location.href = "login.html"; }
    </script>
</body>
</html>